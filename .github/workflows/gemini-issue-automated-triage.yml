# Geminiã«ã‚ˆã‚‹Issueã®è‡ªå‹•ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚’è¡Œã†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: ğŸ·ï¸ Gemini Automated Issue Triage

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
on:
  # IssueãŒã‚ªãƒ¼ãƒ—ãƒ³ã¾ãŸã¯å†ã‚ªãƒ¼ãƒ—ãƒ³ã•ã‚ŒãŸæ™‚
  issues:
    types: [opened, reopened]
  # Issueã«ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚ŒãŸæ™‚
  issue_comment:
    types: [created]
  # æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'ãƒˆãƒªã‚¢ãƒ¼ã‚¸å¯¾è±¡ã®Issueç•ªå·'
        required: true
        type: number

# å®Ÿè¡Œã•ã‚Œã‚‹ã‚¸ãƒ§ãƒ–ã‚’å®šç¾©
jobs:
  # ã‚¸ãƒ§ãƒ–ID
  triage-issue:
    # ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œæ¡ä»¶
    if: >
      github.event_name == 'issues' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && 
       contains(github.event.comment.body, '@gemini-cli /triage') &&
       (github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'))
    # ã‚¸ãƒ§ãƒ–ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ã‚’5åˆ†ã«è¨­å®š
    timeout-minutes: 5
    # ã‚¸ãƒ§ãƒ–ã«ä¸ãˆã‚‹æ¨©é™ã‚’è¨­å®š
    permissions:
      issues: write          # Issueã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      contents: read         # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®èª­ã¿å–ã‚Šæ¨©é™
      id-token: write        # OIDCãƒˆãƒ¼ã‚¯ãƒ³ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
    # åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.issue.number }} # åŒä¸€Issueã§ã®é‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢
      cancel-in-progress: true # é€²è¡Œä¸­ã®ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    # ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ãƒ©ãƒ³ãƒŠãƒ¼ã‚’æŒ‡å®š
    runs-on: ubuntu-latest
    # ã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®šç¾©
    steps:
      # GitHub Appã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      - name: Generate GitHub App Token
        id: generate_token
        if: ${{ vars.APP_ID }} # APP_IDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}           # GitHub Appã®ID
          private-key: ${{ secrets.PRIVATE_KEY }} # GitHub Appã®ç§˜å¯†éµ

      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }} # èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³

      # Geminiã«ã‚ˆã‚‹Issueãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒƒãƒ—
      - name: Run Gemini Issue Triage
        uses: google-gemini/gemini-cli-action@main
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}   # Issueã®ã‚¿ã‚¤ãƒˆãƒ«
          ISSUE_BODY: ${{ github.event.issue.body }}     # Issueã®æœ¬æ–‡
          ISSUE_NUMBER: ${{ github.event.issue.number }} # Issueã®ç•ªå·
          REPOSITORY: ${{ github.repository }}
        with:
          # Gemini APIã‚­ãƒ¼ã¨GCPã®èªè¨¼æƒ…å ±ã‚’secretsã‹ã‚‰è¨­å®š
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OTLP_GCP_WIF_PROVIDER: ${{ secrets.OTLP_GCP_WIF_PROVIDER }}
          OTLP_GOOGLE_CLOUD_PROJECT: ${{ secrets.OTLP_GOOGLE_CLOUD_PROJECT }}
          # Gemini CLIã®å‹•ä½œè¨­å®š
          settings_json: |
            {
              "coreTools": [
                "run_shell_command(gh label list)",
                "run_shell_command(gh issue edit)"
              ],
              "telemetry": {
                "enabled": true,
                "target": "gcp"
              },
              "sandbox": false
            }
          # Geminiãƒ¢ãƒ‡ãƒ«ã¸ã®æŒ‡ç¤ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
          prompt: |
            You are an issue triage assistant. Analyze the current GitHub issue and apply the most appropriate existing labels.

            Steps:
            1. Run: `gh label list` to get all available labels.
            2. Review the issue title and body provided in the environment variables.
            3. Select the most relevant labels from the existing labels. If available, set labels that follow the `kind/*`, `area/*`, and `priority/*` patterns.
            4. Apply the selected labels to this issue using: `gh issue edit ISSUE_NUMBER --add-label "label1,label2"`
            5. If the `status/needs-triage` label is present, remove it using: `gh issue edit ISSUE_NUMBER --remove-label "status/needs-triage"`

            Guidelines:
            - Only use labels that already exist in the repository.
            - Do not add comments or modify the issue content.
            - Triage only the current issue.
            - Assign all applicable labels based on the issue content.
