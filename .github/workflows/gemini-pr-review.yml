# Geminiã«ã‚ˆã‚‹ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: ğŸ§ Gemini Pull Request Review

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
on:
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ªãƒ¼ãƒ—ãƒ³ã•ã‚ŒãŸæ™‚
  pull_request:
    types: [opened]
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚ŒãŸæ™‚
  pull_request_review_comment:
    types: [created]
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæå‡ºã•ã‚ŒãŸæ™‚
  pull_request_review:
    types: [submitted]
  # æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®PRç•ªå·'
        required: true
        type: number

# å®Ÿè¡Œã•ã‚Œã‚‹ã‚¸ãƒ§ãƒ–ã‚’å®šç¾©
jobs:
  # ã‚¸ãƒ§ãƒ–ID
  review-pr:
    # ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œæ¡ä»¶
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.action == 'opened') ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '@gemini-cli /review') &&
        (github.event.comment.author_association == 'OWNER' ||
         github.event.comment.author_association == 'MEMBER' ||
         github.event.comment.author_association == 'COLLABORATOR')) ||
      (github.event_name == 'pull_request_review_comment' &&
        contains(github.event.comment.body, '@gemini-cli /review') &&
        (github.event.comment.author_association == 'OWNER' ||
         github.event.comment.author_association == 'MEMBER' ||
         github.event.comment.author_association == 'COLLABORATOR')) ||
      (github.event_name == 'pull_request_review' &&
        contains(github.event.review.body, '@gemini-cli /review') &&
        (github.event.review.author_association == 'OWNER' ||
         github.event.review.author_association == 'MEMBER' ||
         github.event.review.author_association == 'COLLABORATOR'))
    # ã‚¸ãƒ§ãƒ–ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ã‚’15åˆ†ã«è¨­å®š
    timeout-minutes: 15
    # ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ãƒ©ãƒ³ãƒŠãƒ¼ã‚’æŒ‡å®š
    runs-on: ubuntu-latest
    # ã‚¸ãƒ§ãƒ–ã«ä¸ãˆã‚‹æ¨©é™ã‚’è¨­å®š
    permissions:
      contents: read          # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®èª­ã¿å–ã‚Šæ¨©é™
      id-token: write          # OIDCãƒˆãƒ¼ã‚¯ãƒ³ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      pull-requests: write     # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      issues: write            # issueã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
    # ã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®šç¾©
    steps:
      # GitHub Appã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      - name: Generate GitHub App Token
        id: generate_token
        if: ${{ vars.APP_ID }} # APP_IDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}           # GitHub Appã®ID
          private-key: ${{ secrets.PRIVATE_KEY }} # GitHub Appã®ç§˜å¯†éµ

      # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }} # èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
          fetch-depth: 0                               # å…¨ã¦ã®å±¥æ­´ã‚’å–å¾—

      # PRè©³ç´°ã‚’å–å¾—ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ— (pull_request, workflow_dispatchã‚¤ãƒ™ãƒ³ãƒˆç”¨)
            - name: Get PR details (pull_request & workflow_dispatch)
        id: get_pr
        if: github.event_name == 'pull_request' or github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦PRç•ªå·ã‚’å–å¾—
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER=${{ github.event.inputs.pr_number }}
          else
            PR_NUMBER=${{ github.event.pull_request.number }}
          fi
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          # ghã‚³ãƒãƒ³ãƒ‰ã§PRã®è©³ç´°ã‚’å–å¾—
          PR_DATA=$(gh pr view $PR_NUMBER --json title,body,additions,deletions,changedFiles,baseRefName,headRefName)
          echo "pr_data=$PR_DATA" >> "$GITHUB_OUTPUT"
          # ghã‚³ãƒãƒ³ãƒ‰ã§å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã‚’å–å¾—
          CHANGED_FILES=$(gh pr diff $PR_NUMBER --name-only)
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED_FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # PRè©³ç´°ã‚’å–å¾—ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ— (issue_commentã‚¤ãƒ™ãƒ³ãƒˆç”¨)
      - name: Get PR details (issue_comment)
        id: get_pr_comment
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          PR_NUMBER=${{ github.event.issue.number }}
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          # ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰è¿½åŠ ã®æŒ‡ç¤ºã‚’æŠ½å‡º
          ADDITIONAL_INSTRUCTIONS=$(echo "$COMMENT_BODY" | sed 's/.*@gemini-cli \/review//' | xargs)
          echo "additional_instructions=$ADDITIONAL_INSTRUCTIONS" >> "$GITHUB_OUTPUT"
          # ghã‚³ãƒãƒ³ãƒ‰ã§PRã®è©³ç´°ã‚’å–å¾—
          PR_DATA=$(gh pr view $PR_NUMBER --json title,body,additions,deletions,changedFiles,baseRefName,headRefName)
          echo "pr_data=$PR_DATA" >> "$GITHUB_OUTPUT"
          # ghã‚³ãƒãƒ³ãƒ‰ã§å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã‚’å–å¾—
          CHANGED_FILES=$(gh pr diff $PR_NUMBER --name-only)
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED_FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # Geminiã«ã‚ˆã‚‹PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒƒãƒ—
      - name: Run Gemini PR Review
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
          PR_NUMBER: ${{ steps.get_pr.outputs.pr_number || steps.get_pr_comment.outputs.pr_number }}
          PR_DATA: ${{ steps.get_pr.outputs.pr_data || steps.get_pr_comment.outputs.pr_data }}
          CHANGED_FILES: ${{ steps.get_pr.outputs.changed_files || steps.get_pr_comment.outputs.changed_files }}
          ADDITIONAL_INSTRUCTIONS: ${{ steps.get_pr.outputs.additional_instructions || steps.get_pr_comment.outputs.additional_instructions }}
          REPOSITORY: ${{ github.repository }}
        with:
          # Gemini APIã‚­ãƒ¼ã¨GCPã®èªè¨¼æƒ…å ±ã‚’secretsã‹ã‚‰è¨­å®š
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OTLP_GCP_WIF_PROVIDER: ${{ secrets.OTLP_GCP_WIF_PROVIDER }}
          OTLP_GOOGLE_CLOUD_PROJECT: ${{ secrets.OTLP_GOOGLE_CLOUD_PROJECT }}
          # Gemini CLIã®å‹•ä½œè¨­å®š
          settings_json: |
            {
              "coreTools": [
                "run_shell_command(echo)",
                "run_shell_command(gh pr view)",
                "run_shell_command(gh pr diff)",
                "run_shell_command(gh pr comment)",
                "run_shell_command(cat)",
                "run_shell_command(head)",
                "run_shell_command(tail)",
                "run_shell_command(grep)",
                "write_file"
              ],
              "telemetry": {
                "enabled": true,
                "target": "gcp"
              },
              "sandbox": false
            }
          # Geminiãƒ¢ãƒ‡ãƒ«ã¸ã®æŒ‡ç¤ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
          prompt: |
            You are an expert code reviewer. You have access to shell commands to gather PR information and perform the review.
            
            IMPORTANT: Use the available shell commands to gather information. Do not ask for information to be provided.
            
            Start by running these commands to gather the required data:
            1. Run: echo "$PR_DATA" to get PR details (JSON format)
            2. Run: echo "$CHANGED_FILES" to get the list of changed files
            3. Run: echo "$PR_NUMBER" to get the PR number
            4. Run: echo "$ADDITIONAL_INSTRUCTIONS" to see any specific review instructions from the user
            5. Run: gh pr diff $PR_NUMBER to see the full diff
            6. For any specific files, use: cat filename, head -50 filename, or tail -50 filename
            
            Additional Review Instructions:
            If ADDITIONAL_INSTRUCTIONS contains text, prioritize those specific areas or focus points in your review.
            Common instruction examples: "focus on security", "check performance", "review error handling", "check for breaking changes"
            
            Once you have the information, provide a comprehensive code review by:
            1. Writing your review to a file: write_file("review.md", "<your detailed review feedback here>")
            2. Posting the review: gh pr comment $PR_NUMBER --body-file review.md --repo $REPOSITORY
            
            Review Areas:
            - **Security**: Authentication, authorization, input validation, data sanitization
            - **Performance**: Algorithms, database queries, caching, resource usage
            - **Reliability**: Error handling, logging, testing coverage, edge cases
            - **Maintainability**: Code structure, documentation, naming conventions
            - **Functionality**: Logic correctness, requirements fulfillment
            
            Output Format:
            Structure your review using this exact format with markdown:
            
            ## ğŸ“‹ Review Summary
            Provide a brief 2-3 sentence overview of the PR and overall assessment.
            
            ## ğŸ” General Feedback
            - List general observations about code quality
            - Mention overall patterns or architectural decisions
            - Highlight positive aspects of the implementation
            - Note any recurring themes across files
            
            ## ğŸ¯ Specific Feedback
            Only include sections below that have actual issues. If there are no issues in a priority category, omit that entire section.
            
            ### ğŸ”´ Critical
            (Only include this section if there are critical issues)
            Issues that must be addressed before merging (security vulnerabilities, breaking changes, major bugs):
            - **File: `filename:line`** - Description of critical issue with specific recommendation
            
            ### ğŸŸ¡ High
            (Only include this section if there are high priority issues)
            Important issues that should be addressed (performance problems, design flaws, significant bugs):
            - **File: `filename:line`** - Description of high priority issue with suggested fix
            
            ### ğŸŸ¢ Medium
            (Only include this section if there are medium priority issues)
            Improvements that would enhance code quality (style issues, minor optimizations, better practices):
            - **File: `filename:line`** - Description of medium priority improvement
            
            ### ğŸ”µ Low
            (Only include this section if there are suggestions)
            Nice-to-have improvements and suggestions (documentation, naming, minor refactoring):
            - **File: `filename:line`** - Description of suggestion or enhancement
            
            **Note**: If no specific issues are found in any category, simply state "No specific issues identified in this review."
            
            ## âœ… Highlights
            (Only include this section if there are positive aspects to highlight)
            - Mention specific good practices or implementations
            - Acknowledge well-written code sections
            - Note improvements from previous versions
