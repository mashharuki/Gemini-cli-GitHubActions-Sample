# Gemini CLI ã¨ GitHub Actions ã‚’é€£æºã•ã›ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚µãƒ³ãƒ—ãƒ«

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å
name: Gemini CLI

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
on:
  # issueã«ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚ŒãŸæ™‚
  issue_comment:
    types: [created]
  # pull requestã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚ŒãŸæ™‚
  pull_request_review_comment:
    types: [created]
  # issueãŒã‚ªãƒ¼ãƒ—ãƒ³ã¾ãŸã¯ã‚¢ã‚µã‚¤ãƒ³ã•ã‚ŒãŸæ™‚
  issues:
    types: [opened, assigned]
  # pull requestã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæå‡ºã•ã‚ŒãŸæ™‚
  pull_request_review:
    types: [submitted]

# å®Ÿè¡Œã•ã‚Œã‚‹ã‚¸ãƒ§ãƒ–ã‚’å®šç¾©
jobs:
  # ã‚¸ãƒ§ãƒ–ID
  gemini-cli:
    # ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œæ¡ä»¶
    # issueã‚³ãƒ¡ãƒ³ãƒˆã€PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã€ã¾ãŸã¯PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æœ¬æ–‡ã«ã€Œ@gemini-cliã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã«å®Ÿè¡Œ
    # ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿è€…ãŒãƒªãƒã‚¸ãƒˆãƒªã®OWNERã€MEMBERã€ã¾ãŸã¯COLLABORATORã§ã‚ã‚‹ã“ã¨ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼‰
    if: |
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini-cli') && !contains(github.event.comment.body, '/review') && !contains(github.event.comment.body, '/triage')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@gemini-cli') && !contains(github.event.comment.body, '/review') && !contains(github.event.comment.body, '/triage')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@gemini-cli') && !contains(github.event.comment.body, '/review') && !contains(github.event.comment.body, '/triage'))) && 
        (
          github.event.comment.author_association == 'OWNER' ||
          github.event.comment.author_association == 'MEMBER' ||
          github.event.comment.author_association == 'COLLABORATOR'
        )
    # ã‚¸ãƒ§ãƒ–ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ã‚’15åˆ†ã«è¨­å®š
    timeout-minutes: 15
    # ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ãƒ©ãƒ³ãƒŠãƒ¼ã‚’æŒ‡å®š
    runs-on: ubuntu-latest
    # ã‚¸ãƒ§ãƒ–ã«ä¸ãˆã‚‹æ¨©é™ã‚’è¨­å®š
    permissions:
      contents: write          # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      id-token: write          # OIDCãƒˆãƒ¼ã‚¯ãƒ³ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      pull-requests: write     # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      issues: write            # issueã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
    # ã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®šç¾©
    steps:
      # GitHub Appã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      - name: Generate GitHub App Token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}           # GitHub Appã®ID
          private-key: ${{ secrets.PRIVATE_KEY }} # GitHub Appã®ç§˜å¯†éµ

      # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      - name: Get PR branch
        id: get_pr_branch
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }} # ç”Ÿæˆã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨
          REPOSITORY: ${{ github.repository }}
        run: |
          # ã‚¤ãƒ™ãƒ³ãƒˆãŒissueã‚³ãƒ¡ãƒ³ãƒˆã®å ´åˆã€issueç•ªå·ã‹ã‚‰PRã‚’ç‰¹å®šã—ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            PR_NUMBER=${{ github.event.issue.number }}
            BRANCH=$(gh pr view "$PR_NUMBER" --json headRefName -q .headRefName --repo "$REPOSITORY")
            echo "name=$BRANCH" >> $GITHUB_OUTPUT
          else
            # ãã‚Œä»¥å¤–ã®å ´åˆã¯ã€pull_requestã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
            echo "name=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          fi
      # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate_token.outputs.token }} # èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
          ref: ${{ steps.get_pr_branch.outputs.name }}   # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒ
          fetch-depth: 0                               # å…¨ã¦ã®å±¥æ­´ã‚’å–å¾—

      # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è©³ç´°æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      - name: Get PR details
        id: get_pr
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
        run: |
          # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦PRç•ªå·ã‚’å–å¾—
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER=${{ github.event.inputs.pr_number }}
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_NUMBER=${{ github.event.issue.number }}
          else
            PR_NUMBER=${{ github.event.pull_request.number }}
          fi
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          # ghã‚³ãƒãƒ³ãƒ‰ã§PRã®è©³ç´°ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€æœ¬æ–‡ãªã©ï¼‰ã‚’å–å¾—
          PR_DATA=$(gh pr view $PR_NUMBER --json title,body,additions,deletions,changedFiles,baseRefName,headRefName)
          echo "pr_data=$PR_DATA" >> "$GITHUB_OUTPUT"
          # ghã‚³ãƒãƒ³ãƒ‰ã§å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã‚’å–å¾—
          CHANGED_FILES=$(gh pr diff $PR_NUMBER --name-only)
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED_FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
      # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ãŸã“ã¨ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      - name: Acknowledge request
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.get_pr.outputs.pr_number }}
          REPOSITORY: ${{ github.repository }}
        run: |
          # PRã«ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€ã¨ã„ã†å†…å®¹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          gh pr comment $PR_NUMBER --body "I've received your request and I'm working on it now! ğŸ¤–" --repo $REPOSITORY
      # Gemini CLIã‚’å®Ÿè¡Œã™ã‚‹ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒƒãƒ—
      - name: Run Gemini
        uses: google-gemini/gemini-cli-action@main
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
          REPOSITORY: ${{ github.repository }}
          USER_REQUEST: ${{github.event.comment.body}} # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦æ¸¡ã™
          PR_NUMBER: ${{ steps.get_pr.outputs.pr_number }}
        with:
          # Gemini APIã‚­ãƒ¼ã¨GCPã®èªè¨¼æƒ…å ±ã‚’secretsã‹ã‚‰è¨­å®š
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OTLP_GCP_WIF_PROVIDER: ${{ secrets.OTLP_GCP_WIF_PROVIDER }}
          OTLP_GOOGLE_CLOUD_PROJECT: ${{ secrets.OTLP_GOOGLE_CLOUD_PROJECT }}
          # Gemini CLIã®å‹•ä½œè¨­å®š
          settings_json: |
            {
              "coreTools": [
                "run_shell_command(echo)",
                "run_shell_command(gh pr view)",
                "run_shell_command(gh pr diff)",
                "run_shell_command(gh pr comment)",
                "run_shell_command(cat)",
                "run_shell_command(head)",
                "run_shell_command(tail)",
                "run_shell_command(grep)",
                "run_shell_command(git config)",
                "run_shell_command(git status)",
                "run_shell_command(git add)",
                "run_shell_command(git commit)",
                "run_shell_command(git push)",
                "run_shell_command(git diff)",
                "write_file"
              ],
              "telemetry": {
                "enabled": true,
                "target": "gcp"
              },
              "sandbox": false
            }
          # Geminiãƒ¢ãƒ‡ãƒ«ã¸ã®æŒ‡ç¤ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
          prompt: |
            IMPORTANT: Use the available shell commands to gather information if needed. Do not ask for information to be
            provided.
            Start by running these commands to gather the required data:
              1. Run: echo "$USER_REQUEST" to get the user request
              2. Run: echo "$REPOSITORY to get the repository
              3. Run: echo "$PR_NUMBER" to get the PR number
              3. For any specific files, use: cat filename, head -50 filename, or tail -50 filename
            Answer the $USER_REQUEST;
            Once you are ready to provide a response, follow the steps bellow to do so:
            1. If you have made any modifications to files, add them using 'git add .' IMPORTANT: do not add response.md file.
            2. Commit the changes with a descriptive message using 'git commit -m "your commit message"'.
            3. Push the changes to the branch using 'git push'.
            4. Writing your response to a file: write_file("response.md", "<your response here>")
            5. Posting the response: gh pr comment $PR_NUMBER --body-file response.md --repo $REPOSITORY